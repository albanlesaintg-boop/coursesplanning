<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#f97316">
    <meta name="description" content="Planifiez vos repas et générez automatiquement votre liste de courses">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Mes Repas">
    <title>Mes Repas - Planificateur</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overscroll-behavior: none;
        }
        * {
            box-sizing: border-box;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Icônes SVG inline
        const ChefHat = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 7.08 0A5.11 5.11 0 0 1 16.59 6 4 4 0 0 1 18 13.87V21H6Z"/>
                <line x1="6" y1="17" x2="18" y2="17"/>
            </svg>
        );
        
        const Calendar = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
        );
        
        const List = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="8" y1="6" x2="21" y2="6"/>
                <line x1="8" y1="12" x2="21" y2="12"/>
                <line x1="8" y1="18" x2="21" y2="18"/>
                <line x1="3" y1="6" x2="3.01" y2="6"/>
                <line x1="3" y1="12" x2="3.01" y2="12"/>
                <line x1="3" y1="18" x2="3.01" y2="18"/>
            </svg>
        );
        
        const ShoppingCart = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="9" cy="21" r="1"/>
                <circle cx="20" cy="21" r="1"/>
                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
            </svg>
        );
        
        const Plus = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
        );
        
        const Trash2 = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                <line x1="10" y1="11" x2="10" y2="17"/>
                <line x1="14" y1="11" x2="14" y2="17"/>
            </svg>
        );
        
        const Download = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
        );

        const MealPlannerApp = () => {
            const [recipes, setRecipes] = useState([]);
            const [weekPlan, setWeekPlan] = useState({});
            const [activeTab, setActiveTab] = useState('plan');
            const [showRecipeForm, setShowRecipeForm] = useState(false);
            const [newRecipe, setNewRecipe] = useState({
                name: '',
                ingredients: [{ name: '', quantity: '', unit: 'g' }]
            });

            const days = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
            const meals = ['midi', 'soir'];
            const units = ['g', 'kg', 'ml', 'l', 'pièce(s)', 'c. à soupe', 'c. à café'];

            useEffect(() => {
                const savedRecipes = localStorage.getItem('mealPlanner_recipes');
                const savedPlan = localStorage.getItem('mealPlanner_weekPlan');
                
                if (savedRecipes) {
                    setRecipes(JSON.parse(savedRecipes));
                }
                
                if (savedPlan) {
                    setWeekPlan(JSON.parse(savedPlan));
                } else {
                    const initialPlan = {};
                    days.forEach(day => {
                        initialPlan[day] = { 
                            midi: { recipeId: null, servings: 1 }, 
                            soir: { recipeId: null, servings: 1 } 
                        };
                    });
                    setWeekPlan(initialPlan);
                }
            }, []);

            useEffect(() => {
                if (recipes.length > 0 || localStorage.getItem('mealPlanner_recipes')) {
                    localStorage.setItem('mealPlanner_recipes', JSON.stringify(recipes));
                }
            }, [recipes]);

            useEffect(() => {
                if (Object.keys(weekPlan).length > 0) {
                    localStorage.setItem('mealPlanner_weekPlan', JSON.stringify(weekPlan));
                }
            }, [weekPlan]);

            const addIngredient = () => {
                setNewRecipe({
                    ...newRecipe,
                    ingredients: [...newRecipe.ingredients, { name: '', quantity: '', unit: 'g' }]
                });
            };

            const updateIngredient = (index, field, value) => {
                const updated = [...newRecipe.ingredients];
                updated[index][field] = value;
                setNewRecipe({ ...newRecipe, ingredients: updated });
            };

            const removeIngredient = (index) => {
                const updated = newRecipe.ingredients.filter((_, i) => i !== index);
                setNewRecipe({ ...newRecipe, ingredients: updated });
            };

            const saveRecipe = () => {
                if (newRecipe.name && newRecipe.ingredients.some(i => i.name)) {
                    setRecipes([...recipes, { ...newRecipe, id: Date.now() }]);
                    setNewRecipe({ name: '', ingredients: [{ name: '', quantity: '', unit: 'g' }] });
                    setShowRecipeForm(false);
                }
            };

            const deleteRecipe = (id) => {
                setRecipes(recipes.filter(r => r.id !== id));
                const updatedPlan = { ...weekPlan };
                Object.keys(updatedPlan).forEach(day => {
                    meals.forEach(meal => {
                        if (updatedPlan[day][meal]?.recipeId === id) {
                            updatedPlan[day][meal] = { recipeId: null, servings: 1 };
                        }
                    });
                });
                setWeekPlan(updatedPlan);
            };

            const setMeal = (day, meal, recipeId) => {
                setWeekPlan({
                    ...weekPlan,
                    [day]: { 
                        ...weekPlan[day], 
                        [meal]: { 
                            recipeId: recipeId ? parseInt(recipeId) : null, 
                            servings: weekPlan[day][meal]?.servings || 1 
                        } 
                    }
                });
            };

            const setServings = (day, meal, servings) => {
                setWeekPlan({
                    ...weekPlan,
                    [day]: { 
                        ...weekPlan[day], 
                        [meal]: { 
                            ...weekPlan[day][meal], 
                            servings: parseInt(servings) || 1 
                        } 
                    }
                });
            };

            const generateShoppingList = () => {
                const list = {};
                
                Object.keys(weekPlan).forEach(day => {
                    meals.forEach(meal => {
                        const mealData = weekPlan[day][meal];
                        if (mealData?.recipeId) {
                            const recipe = recipes.find(r => r.id === mealData.recipeId);
                            if (recipe) {
                                const multiplier = mealData.servings;
                                recipe.ingredients.forEach(ing => {
                                    if (ing.name) {
                                        const key = `${ing.name.toLowerCase()}_${ing.unit}`;
                                        const adjustedQuantity = (parseFloat(ing.quantity) || 0) * multiplier;
                                        if (list[key]) {
                                            list[key].quantity += adjustedQuantity;
                                        } else {
                                            list[key] = {
                                                name: ing.name,
                                                quantity: adjustedQuantity,
                                                unit: ing.unit
                                            };
                                        }
                                    }
                                });
                            }
                        }
                    });
                });

                return Object.values(list);
            };

            const exportData = () => {
                const data = {
                    recipes,
                    weekPlan,
                    exportDate: new Date().toISOString()
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'mes-repas-backup.json';
                a.click();
                URL.revokeObjectURL(url);
            };

            const importData = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.recipes) setRecipes(data.recipes);
                            if (data.weekPlan) setWeekPlan(data.weekPlan);
                            alert('Données importées avec succès !');
                        } catch (error) {
                            alert('Erreur lors de l\'importation du fichier');
                        }
                    };
                    reader.readAsText(file);
                }
            };

            const shoppingList = generateShoppingList();

            return (
                <div className="min-h-screen bg-gradient-to-br from-orange-50 to-red-50 pb-20">
                    <div className="bg-gradient-to-r from-orange-500 to-red-500 text-white p-6 shadow-lg sticky top-0 z-10">
                        <div className="max-w-4xl mx-auto">
                            <h1 className="text-3xl font-bold flex items-center gap-3">
                                <ChefHat size={36} />
                                Mes Repas
                            </h1>
                            <p className="text-orange-100 text-sm mt-1">Planifiez vos repas et courses</p>
                        </div>
                    </div>

                    <div className="flex bg-white shadow-md sticky top-20 z-10">
                        <button
                            onClick={() => setActiveTab('plan')}
                            className={`flex-1 py-4 flex items-center justify-center gap-2 font-semibold transition ${
                                activeTab === 'plan' ? 'bg-orange-500 text-white' : 'text-gray-600 hover:bg-orange-50'
                            }`}
                        >
                            <Calendar size={20} />
                            Planning
                        </button>
                        <button
                            onClick={() => setActiveTab('recipes')}
                            className={`flex-1 py-4 flex items-center justify-center gap-2 font-semibold transition ${
                                activeTab === 'recipes' ? 'bg-orange-500 text-white' : 'text-gray-600 hover:bg-orange-50'
                            }`}
                        >
                            <List size={20} />
                            Recettes ({recipes.length})
                        </button>
                        <button
                            onClick={() => setActiveTab('shopping')}
                            className={`flex-1 py-4 flex items-center justify-center gap-2 font-semibold transition ${
                                activeTab === 'shopping' ? 'bg-orange-500 text-white' : 'text-gray-600 hover:bg-orange-50'
                            }`}
                        >
                            <ShoppingCart size={20} />
                            Courses
                            {shoppingList.length > 0 && (
                                <span className="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">
                                    {shoppingList.length}
                                </span>
                            )}
                        </button>
                    </div>

                    <div className="p-4 max-w-4xl mx-auto">
                        {activeTab === 'plan' && (
                            <div className="space-y-4">
                                {days.map(day => (
                                    <div key={day} className="bg-white rounded-lg shadow-md p-4">
                                        <h3 className="font-bold text-lg text-orange-600 mb-3">{day}</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                            {meals.map(meal => (
                                                <div key={meal} className="border border-gray-200 rounded-lg p-3 bg-gray-50">
                                                    <label className="block text-sm font-bold text-gray-700 mb-2 capitalize">
                                                        {meal}
                                                    </label>
                                                    <select
                                                        value={weekPlan[day]?.[meal]?.recipeId || ''}
                                                        onChange={(e) => setMeal(day, meal, e.target.value)}
                                                        className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent mb-2"
                                                    >
                                                        <option value="">-- Choisir une recette --</option>
                                                        {recipes.map(recipe => (
                                                            <option key={recipe.id} value={recipe.id}>
                                                                {recipe.name}
                                                            </option>
                                                        ))}
                                                    </select>
                                                    <div className="flex items-center gap-2">
                                                        <label className="text-sm text-gray-600 font-medium">Personnes:</label>
                                                        <input
                                                            type="number"
                                                            min="1"
                                                            max="20"
                                                            value={weekPlan[day]?.[meal]?.servings || 1}
                                                            onChange={(e) => setServings(day, meal, e.target.value)}
                                                            className="w-16 p-1.5 border border-gray-300 rounded focus:ring-2 focus:ring-orange-500 text-center font-semibold"
                                                        />
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {activeTab === 'recipes' && (
                            <div className="space-y-4">
                                <button
                                    onClick={() => setShowRecipeForm(!showRecipeForm)}
                                    className="w-full bg-gradient-to-r from-orange-500 to-red-500 text-white py-3 rounded-lg font-semibold flex items-center justify-center gap-2 hover:from-orange-600 hover:to-red-600 transition shadow-md"
                                >
                                    <Plus size={20} />
                                    Nouvelle Recette
                                </button>

                                {showRecipeForm && (
                                    <div className="bg-white rounded-lg shadow-lg p-6">
                                        <h3 className="text-xl font-bold text-gray-800 mb-4">Créer une Recette</h3>
                                        
                                        <input
                                            type="text"
                                            placeholder="Nom de la recette"
                                            value={newRecipe.name}
                                            onChange={(e) => setNewRecipe({ ...newRecipe, name: e.target.value })}
                                            className="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                        />

                                        <h4 className="font-semibold text-gray-700 mb-2">Ingrédients (quantités pour 1 personne)</h4>
                                        {newRecipe.ingredients.map((ing, index) => (
                                            <div key={index} className="flex gap-2 mb-2">
                                                <input
                                                    type="text"
                                                    placeholder="Ingrédient"
                                                    value={ing.name}
                                                    onChange={(e) => updateIngredient(index, 'name', e.target.value)}
                                                    className="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                                                />
                                                <input
                                                    type="number"
                                                    placeholder="Qté"
                                                    value={ing.quantity}
                                                    onChange={(e) => updateIngredient(index, 'quantity', e.target.value)}
                                                    className="w-20 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                                                />
                                                <select
                                                    value={ing.unit}
                                                    onChange={(e) => updateIngredient(index, 'unit', e.target.value)}
                                                    className="w-28 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                                                >
                                                    {units.map(u => <option key={u} value={u}>{u}</option>)}
                                                </select>
                                                <button
                                                    onClick={() => removeIngredient(index)}
                                                    className="p-2 text-red-500 hover:bg-red-50 rounded-lg transition"
                                                >
                                                    <Trash2 size={20} />
                                                </button>
                                            </div>
                                        ))}

                                        <button
                                            onClick={addIngredient}
                                            className="text-orange-600 font-medium mb-4 hover:text-orange-700"
                                        >
                                            + Ajouter un ingrédient
                                        </button>

                                        <div className="flex gap-2">
                                            <button
                                                onClick={saveRecipe}
                                                className="flex-1 bg-green-500 text-white py-2 rounded-lg font-semibold hover:bg-green-600 transition"
                                            >
                                                Enregistrer
                                            </button>
                                            <button
                                                onClick={() => setShowRecipeForm(false)}
                                                className="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg font-semibold hover:bg-gray-400 transition"
                                            >
                                                Annuler
                                            </button>
                                        </div>
                                    </div>
                                )}

                                <div className="flex gap-2">
                                    <button
                                        onClick={exportData}
                                        className="flex-1 bg-blue-500 text-white py-2 rounded-lg font-semibold hover:bg-blue-600 transition flex items-center justify-center gap-2"
                                    >
                                        <Download size={18} />
                                        Exporter
                                    </button>
                                    <label className="flex-1 bg-green-500 text-white py-2 rounded-lg font-semibold hover:bg-green-600 transition flex items-center justify-center gap-2 cursor-pointer">
                                        <Plus size={18} />
                                        Importer
                                        <input
                                            type="file"
                                            accept=".json"
                                            onChange={importData}
                                            className="hidden"
                                        />
                                    </label>
                                </div>

                                <div className="space-y-3">
                                    {recipes.map(recipe => (
                                        <div key={recipe.id} className="bg-white rounded-lg shadow-md p-4">
                                            <div className="flex justify-between items-start mb-2">
                                                <div>
                                                    <h3 className="font-bold text-lg text-gray-800">{recipe.name}</h3>
                                                    <p className="text-sm text-gray-500 italic">Quantités pour 1 personne</p>
                                                </div>
                                                <button
                                                    onClick={() => deleteRecipe(recipe.id)}
                                                    className="text-red-500 hover:bg-red-50 p-2 rounded-lg transition"
                                                >
                                                    <Trash2 size={20} />
                                                </button>
                                            </div>
                                            <div className="text-sm text-gray-600">
                                                {recipe.ingredients.map((ing, i) => (
                                                    <div key={i}>
                                                        • {ing.name} - {ing.quantity} {ing.unit}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                    {recipes.length === 0 && (
                                        <div className="text-center text-gray-500 py-8">
                                            Aucune recette. Créez-en une pour commencer !
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === 'shopping' && (
                            <div className="bg-white rounded-lg shadow-lg p-6">
                                <h2 className="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                                    <ShoppingCart size={28} className="text-orange-500" />
                                    Liste de Courses
                                </h2>
                                
                                {shoppingList.length > 0 ? (
                                    <div className="space-y-2">
                                        {shoppingList.map((item, index) => (
                                            <div key={index} className="flex justify-between items-center p-3 bg-orange-50 rounded-lg">
                                                <span className="font-medium text-gray-800 capitalize">{item.name}</span>
                                                <span className="text-orange-600 font-semibold">
                                                    {item.quantity > 0 ? Math.round(item.quantity * 10) / 10 : ''} {item.unit}
                                                </span>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="text-center text-gray-500 py-8">
                                        Planifiez vos repas pour générer votre liste de courses
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<MealPlannerApp />, document.getElementById('root'));
    </script>

    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(reg => console.log('Service Worker enregistré'))
                    .catch(err => console.log('Erreur Service Worker:', err));
            });
        }
    </script>
</body>
</html>
